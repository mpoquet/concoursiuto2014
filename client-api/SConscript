import distutils.sysconfig
import re


# User variables
moduleName = 'contest'
installPath = 'install'
javaIncludePath = '/usr/lib/jvm/java-1.6.0-openjdk-i386/include'

# Internal variables
srcDir = 'src'
spnlInstallPath = 'spnl-install'
includePath = ['#../server', spnlInstallPath+'/include']
libPath = [spnlInstallPath+'/lib']
libs = ['spnl']


def make():
    envBase = Environment(CPPPATH = includePath, LIBS = libs, LIBPATH = libPath)
    #SetOption('implicit_cache', 1)

    lib = makeSpnl(envBase)

    srcFiles = envBase.Glob(srcDir+'/*.cpp')
    objFiles = envBase.SharedObject(srcFiles)
    envBase.Requires(objFiles, lib)
    
    #makeCpp(envBase, objFiles, lib)
    #makePython(envBase, objFiles, lib)
    #makeJava(envBase, objFiles, lib)


def makeSpnl(envBase):
    currentPath = Dir('.').abspath
    projectPath = Dir('#').abspath
    spnlSrcDir = projectPath+'/spnl'
    spnlBuildDir = currentPath+'/spnl-build'
    spnlInstallDir = Dir(spnlInstallPath).abspath

    commands = [Mkdir(spnlBuildDir),
                ' && '.join(['cd '+spnlBuildDir,
                             'cmake '+spnlSrcDir+' -DCMAKE_INSTALL_PREFIX:PATH='+spnlInstallDir,
                             'make install -j'+str(GetOption('num_jobs'))])]
    
    envSpnl = envBase.Clone()
    envSpnl['CPPPATH'] = envSpnl['LIBS'] = envSpnl['LIBPATH'] = []
    generatedFiles = [
                        spnlInstallDir+'/include/spnl/Core/ArgumentException.hpp',
                        spnlInstallDir+'/include/spnl/Core/ByteArray.hpp',
                        spnlInstallDir+'/include/spnl/Core/Errors.hpp',
                        spnlInstallDir+'/include/spnl/Core/Init.hpp',
                        spnlInstallDir+'/include/spnl/Core/InitialisationException.hpp',
                        spnlInstallDir+'/include/spnl/Events/EventArgs.hpp',
                        spnlInstallDir+'/include/spnl/Events/EventHandlerBase.hpp',
                        spnlInstallDir+'/include/spnl/Events/EventHandler.hpp',
                        spnlInstallDir+'/include/spnl/Events/Event.hpp',
                        spnlInstallDir+'/include/spnl/Network/Dns.hpp',
                        spnlInstallDir+'/include/spnl/Network/Errors.hpp',
                        spnlInstallDir+'/include/spnl/Network/IpAddress.hpp',
                        spnlInstallDir+'/include/spnl/Network/IpEndPoint.hpp',
                        spnlInstallDir+'/include/spnl/Network/NetworkException.hpp',
                        spnlInstallDir+'/include/spnl/Network/Socket.hpp',
                        spnlInstallDir+'/include/spnl/Network/SocketSet.hpp',
                        spnlInstallDir+'/include/spnl/Network/TcpSocket.hpp',
                        spnlInstallDir+'/include/spnl/Network/UdpSocket.hpp',
                        spnlInstallDir+'/include/spnl/System/Mutex.hpp',
                        spnlInstallDir+'/include/spnl/System/Semaphore.hpp',
                        spnlInstallDir+'/include/spnl/System/ThreadException.hpp',
                        spnlInstallDir+'/include/spnl/System/Thread.hpp',
                        spnlInstallDir+'/include/spnl/Text/Group.hpp',
                        spnlInstallDir+'/include/spnl/Text/Match.hpp',
                        spnlInstallDir+'/include/spnl/Text/Regex.hpp',
                        spnlInstallDir+'/include/spnl/Network.hpp',
                        spnlInstallDir+'/lib/libspnl.a',
                     ]


    spnlBuild = envSpnl.Command(generatedFiles, 'spnl', commands)
    #tmp = Glob(spnlSrcDir+'/include/spnl/*/*.hpp')+Glob(spnlSrcDir+'/include/spnl/*.hpp')+Glob(spnlSrcDir+'/lib/*.a')
    #generatedFiles = [re.sub('^'+re.escape(spnlSrcDir), spnlInstallDir, i) for i in tmp]
    #print spnlSrcDir+'/include/spnl/*/*.hpp'
    return envSpnl.AlwaysBuild(spnlBuild)


def makeCpp(envBase, objFiles, lib):
    envCpp = envBase.Clone()
    libCpp = envCpp.SharedLibrary(moduleName+'-cpp', objFiles)
    envCpp.Requires(libCpp, lib)


def makePython(envBase, objFiles, lib):
    pythonVersion = distutils.sysconfig.get_python_version().split('.')[0]
    print 'Python', pythonVersion, 'used'

    envPy = envBase.Clone()
    envPy['SWIGFLAGS'] = ['-python', '-c++']
    envPy['CPPPATH'] = [distutils.sysconfig.get_python_inc()]
    envPy['SWIGCXXFILESUFFIX'] = '-python.cxx'
    envPy['SHLIBPREFIX'] = ''
    libPy = envPy.SharedLibrary('_'+moduleName, [srcDir+'/'+moduleName+'.i'])
    envPy.Requires(libPy, lib)
    envPy.Install('.', srcDir+'/'+moduleName+'.py')


def makeJava(envBase, objFiles, lib):
    envJava = envBase.Clone()
    envJava['SWIGFLAGS'] = ['-java', '-c++']
    envJava['CPPPATH'] = [javaIncludePath]
    envJava['SWIGOUTDIR'] = Dir(srcDir).abspath+'/java'
    envJava['SWIGCXXFILESUFFIX'] = '-java.cxx'
    libJava = envJava.SharedLibrary(moduleName, [srcDir+'/'+moduleName+'.i'])
    envJava.Requires(libJava, lib)
    javaSrc = envJava.Java(srcDir+'/classes', [srcDir+'/'+moduleName+'.i'])
    javaJar = envJava.Jar(moduleName+'.jar', javaSrc)


make()


